<!DOCTYPE HTML>
<html>
<head>
<title>GMap Streetview example</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnRF3NrC3g67anVpLYCVUaV7h-HIow_H4"></script>
<!-- <script src="index.js"></script> -->
<style>
.cell {
	width: 100%;
}
td {
	white-space:nowrap;
}
</style>
</head>
<body onload="initialize()">
    <h2>GMap Streetview API テスト </h2>
    <input id="address" type="textbox" value="高崎駅">
    <input type="button" value="検索" onclick="addressSearch()">
    <div style="margin-top: 10px;">
        <div id="map_canvas" style="float:left;width: 600px; height: 400px"></div>
        <div id="pano" style="width: 600px; height: 400px;"></div>
    </div>
    <div id="panoInfo" style="width: 800px; height: 240 px;">
        <table>
            <tr>
                <td><b>location</b></td><td id="location_cell" class="cell">&nbsp;</td>
            </tr>
            <tr>
                <td><b>Streetview image API</b></td><td  class="cell"><input id="stvImageURL" type="text" style="width: 100%" /></td>
            </tr>
        </table>
    </div>
    <div>

    </div>
</body>
</html>

<script>
var map;
var geocoder = new google.maps.Geocoder();
var sv = new google.maps.StreetViewService();
var panorama;


    
function initialize() {
    defPos = new google.maps.LatLng(36.322512, 139.01122399999997);
    
    //蝨ｰ蝗ｳ蛻晄悄蛹� 
    var mapOptions = {
        center: defPos,
        zoom: 14,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);

    //繧ｹ繝医Μ繝ｼ繝医ン繝･繝ｼ蛻晄悄蛹�
    var panoramaOptions = {
		panControl: false,
		addressControl: false,
		linksControl: false,
		zoomControlOptions: false,		
        position: defPos,
        pov: {
            heading: 88,
            pitch: 7
        }
    };  
    panorama = new  google.maps.StreetViewPanorama(document.getElementById('pano'),panoramaOptions);
    map.setStreetView(panorama);
      
  
  
    //繧ｹ繝医Μ繝ｼ繝医ン繝･繝ｼ縺ｫeventListener逋ｻ骭ｲ
    google.maps.event.addListener(panorama, 'position_changed', function() {
		output(panorama);
    });
    google.maps.event.addListener(panorama, 'pov_changed', function() {
		output(panorama);
    });
	
	
}

function output(panorama){
	var location = panorama.getPosition();
	var heading = panorama.getPov().heading;
	var pitch = panorama.getPov().pitch;
	var zoom = panorama.getPov().zoom;
	
	var locationCell = document.getElementById('location_cell');
   
	locationCell.firstChild.nodeValue = location;
	
	var stvImageURL = document.getElementById('stvImageURL');
	stvImageURL.value = "https://maps.googleapis.com/maps/api/streetview?size=400x400"+
	"&location="+ location.toUrlValue() +
	"&heading="+ heading +
	"&pitch="+ pitch +
	"&fov=120" +
	"&zoom=" + zoom;
}

//検索
function addressSearch(){    
    var address = document.getElementById('address').value;    
    geocoder.geocode({ 'address': address}, function(results, status){
        if(status == google.maps.GeocoderStatus.OK) {
            map.setCenter(results[0].geometry.location); //地図を移動
            
            sv.getPanoramaByLocation(    //指定された緯度経度にストリートビューが存在するかチェック
                results[0].geometry.location,
                500, //検索半径(m)
                function(svData,svStatus){
                    if(svStatus == google.maps.StreetViewStatus.OK){
                        panorama.setPosition(svData.location.latLng);    //ストリートビューを移動
                    }else{
                        alert("ストリートビュー対象外地域です")
                    };
                }
            );
        } else {
             alert('座標取得に失敗しました: ' + status);
        }
    });
} 
</script>